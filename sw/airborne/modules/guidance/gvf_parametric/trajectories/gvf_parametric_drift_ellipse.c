
/*
 * Copyright (C) 2020 Mael Feurgard <maelfeurgard@gmail.com>
 *
 * This file is part of paparazzi.
 *
 * paparazzi is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2, or (at your option)
 * any later version.
 *
 * paparazzi is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with paparazzi; see the file COPYING.  If not, see
 * <http://www.gnu.org/licenses/>.
 */

/**
 * @file modules/guidance/gvf_parametric/trajectories/gvf_parametric_drift_ellipse.c
 *
 * Guiding vector field algorithm for 2D and 3D complex trajectories.
 *
 * Drifting growing ellipsis (ellipsis on the XY plane, drifting along X)
 * f(t) = [ -a_y*t*sin(2*pi*f*log(abs(t) + 1) + phi) + t*v_x, a_x*t*cos(2*pi*f*log(abs(t) + 1) + phi), 0 ]
 */

#include "modules/nav/common_nav.h"
//#include "modules/guidance/gvf_parametric/gvf_parametric.h"
#include "../gvf_parametric.h"
#include "gvf_parametric_drift_ellipse.h"

/*! Default gain kx for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KX
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KX 0.001
#endif

/*! Default gain ky for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KY
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KY 0.001
#endif

/*! Default gain kz for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KZ
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KZ 0.001
#endif

/*! Default x-speed for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_V_X
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_V_X 1
#endif

/*! Default x-amplitude for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_X
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_X 1
#endif

/*! Default y-amplitude for the trajectory */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_Y
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_Y 100
#endif

/*! Default frequency */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_FREQ
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_FREQ 1
#endif

/*! Default phase */
#ifndef GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_PHASE
#define GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_PHASE   0
#endif


gvf_par_drift_ellipse_par gvf_parametric_drift_ellipse_par = {GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KX,
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KY, GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_KZ, 
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_V_X,
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_X,
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_A_Y, 
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_FREQ,
                                                  GVF_PARAMETRIC_3D_DRIFT_ELLIPSE_PHASE};



/******************************************************************************************************/
/*                                                                                                    */
/*                               Code autogenerated by SymPy                                          */
/*                                                                                                    */
/******************************************************************************************************/
 
 
 

static double growdrift_ellipse_x(double t, double v_x, double a_y, UNUSED double a_x, double f, double phi) {

   double growdrift_ellipse_x_result;
   growdrift_ellipse_x_result = -a_y*t*sin(2*M_PI*f*log(fabs(t) + 1) + phi) + t*v_x;
   return growdrift_ellipse_x_result;

}

 
 

static double growdrift_ellipse_y(double t, UNUSED double v_x, UNUSED double a_y, double a_x, double f, double phi) {

   double growdrift_ellipse_y_result;
   growdrift_ellipse_y_result = a_x*t*cos(2*M_PI*f*log(fabs(t) + 1) + phi);
   return growdrift_ellipse_y_result;

}

 
 

static double growdrift_ellipse_z(UNUSED double t, UNUSED double v_x, UNUSED double a_y, UNUSED double a_x, UNUSED double f, UNUSED double phi) {

   double growdrift_ellipse_z_result;
   growdrift_ellipse_z_result = 0.;
   return growdrift_ellipse_z_result;

}

/****************************************************************/
 
 

static double growdrift_ellipse_d_x(double t, UNUSED double v_x, double a_y, UNUSED double a_x, double f, double phi) {

   double growdrift_ellipse_d_x_result;
   growdrift_ellipse_d_x_result = -2*M_PI*a_y*f*pow(t, 2)*cos(2*M_PI*f*log(fabs(t) + 1) + phi)/((fabs(t) + 1)*fabs(t)) - a_y*sin(2*M_PI*f*log(fabs(t) + 1) + phi) + v_x;
   return growdrift_ellipse_d_x_result;

}

 
 

static double growdrift_ellipse_d_y(double t, UNUSED double v_x, UNUSED double a_y, double a_x, double f, double phi) {

   double growdrift_ellipse_d_y_result;
   growdrift_ellipse_d_y_result = -2*M_PI*a_x*f*pow(t, 2)*sin(2*M_PI*f*log(fabs(t) + 1) + phi)/((fabs(t) + 1)*fabs(t)) + a_x*cos(2*M_PI*f*log(fabs(t) + 1) + phi);
   return growdrift_ellipse_d_y_result;

}

 
 

static double growdrift_ellipse_d_z(UNUSED double t, UNUSED double v_x, UNUSED double a_y, UNUSED double a_x, UNUSED double f, UNUSED double phi) {

   double growdrift_ellipse_d_z_result;
   growdrift_ellipse_d_z_result = 0.;
   return growdrift_ellipse_d_z_result;

}

/****************************************************************/
 
 

static double growdrift_ellipse_dd_x(double t, UNUSED double v_x, double a_y, UNUSED double a_x, double f, double phi) {

   double growdrift_ellipse_dd_x_result;
   growdrift_ellipse_dd_x_result = 4*pow(M_PI, 2)*a_y*pow(f, 2)*t*sin(2*M_PI*f*log(fabs(t) + 1) + phi)/pow(fabs(t) + 1, 2) - 4*M_PI*a_y*f*t*cos(2*M_PI*f*log(fabs(t) + 1) + phi)/((fabs(t) + 1)*fabs(t)) + 2*M_PI*a_y*f*t*cos(2*M_PI*f*log(fabs(t) + 1) + phi)/pow(fabs(t) + 1, 2);
   return growdrift_ellipse_dd_x_result;

}

 
 

static double growdrift_ellipse_dd_y(double t, UNUSED double v_x, UNUSED double a_y, double a_x, double f, double phi) {

   double growdrift_ellipse_dd_y_result;
   growdrift_ellipse_dd_y_result = -4*pow(M_PI, 2)*a_x*pow(f, 2)*t*cos(2*M_PI*f*log(fabs(t) + 1) + phi)/pow(fabs(t) + 1, 2) - 4*M_PI*a_x*f*t*sin(2*M_PI*f*log(fabs(t) + 1) + phi)/((fabs(t) + 1)*fabs(t)) + 2*M_PI*a_x*f*t*sin(2*M_PI*f*log(fabs(t) + 1) + phi)/pow(fabs(t) + 1, 2);
   return growdrift_ellipse_dd_y_result;
}

 
 

static double growdrift_ellipse_dd_z(UNUSED double t, UNUSED double v_x, UNUSED double a_y, UNUSED double a_x, UNUSED double f, UNUSED double phi) {

   double growdrift_ellipse_dd_z_result;
   growdrift_ellipse_dd_z_result = 0.;
   return growdrift_ellipse_dd_z_result;

}

/******************************************************************************************************/
/*                                                                                                    */
/*                               End of auto-generated code                                           */
/*                                                                                                    */
/******************************************************************************************************/

void gvf_parametric_drift_ellipse_info(float *f1, float *f2, float *f3, float *f1d, float *f2d, float *f3d,
                                  float *f1dd, float *f2dd, float *f3dd)
{
  float v_x = gvf_parametric_trajectory.p_parametric[0];
  float a_x = gvf_parametric_trajectory.p_parametric[1];
  float a_y = gvf_parametric_trajectory.p_parametric[2];
  float freq = gvf_parametric_trajectory.p_parametric[3];
  float phi = gvf_parametric_trajectory.p_parametric[4];

  float w = gvf_parametric_control.w;
  float wb = w * gvf_parametric_control.beta * gvf_parametric_control.s;


  *f1 = growdrift_ellipse_x(wb,v_x,a_x,a_y,freq,phi);
  *f2 = growdrift_ellipse_y(wb,v_x,a_x,a_y,freq,phi);
  *f3 = growdrift_ellipse_z(wb,v_x,a_x,a_y,freq,phi);
  *f1d = growdrift_ellipse_d_x(wb,v_x,a_x,a_y,freq,phi);
  *f2d = growdrift_ellipse_d_y(wb,v_x,a_x,a_y,freq,phi);
  *f3d = growdrift_ellipse_d_z(wb,v_x,a_x,a_y,freq,phi);
  *f1dd = growdrift_ellipse_dd_x(wb,v_x,a_x,a_y,freq,phi);
  *f2dd = growdrift_ellipse_dd_y(wb,v_x,a_x,a_y,freq,phi);
  *f3dd = growdrift_ellipse_dd_z(wb,v_x,a_x,a_y,freq,phi);
}