
/*
 * Copyright (C) 2020 Mael Feurgard <maelfeurgard@gmail.com>
 *
 * This file is part of paparazzi.
 *
 * paparazzi is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2, or (at your option)
 * any later version.
 *
 * paparazzi is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with paparazzi; see the file COPYING.  If not, see
 * <http://www.gnu.org/licenses/>.
 */

/**
 * @file modules/guidance/gvf_parametric/trajectories/gvf_parametric_3d_log_lissajou.c
 *
 * Guiding vector field algorithm for 2D and 3D complex trajectories.
 *
 * Linear growth Lissajou curve along the x-axis 3D, with log adaptation of the oscillations (oscillations along Y and Z axes)
 * f(t) = [ a_x*t, a_y*t*cos(2*pi*f_y*log(abs(t) + 1) + phi_y), a_z*t*sin(2*pi*f_z*log(abs(t) + 1) + phi_z) ]
 */

#include "modules/nav/common_nav.h"
//#include "modules/guidance/gvf_parametric/gvf_parametric.h"
#include "../gvf_parametric.h"
#include "gvf_parametric_3d_log_lissajou.h"

/*! Default gain kx for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_KX
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_KX 0.001
#endif

/*! Default gain ky for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_KY
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_KY 0.001
#endif

/*! Default gain kz for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_KZ
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_KZ 0.001
#endif

/*! Default x-speed for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_AX
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_AX 1
#endif

/*! Default y-amplitude for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_AY
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_AY 100
#endif

/*! Default z-amplitude for the trajectory */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_AZ
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_AZ 1
#endif

/*! Default y-frequency */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Y
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Y 1
#endif

/*! Default y-phase */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Y
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Y   0
#endif


/*! Default z-frequency */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Z
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Z   0
#endif

/*! Default z-phase */
#ifndef GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Z
#define GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Z   0
#endif

gvf_par_3d_log_lissajou_par gvf_parametric_3d_log_lissajou_par = {GVF_PARAMETRIC_3D_LOG_LISSAJOU_KX,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_KY, GVF_PARAMETRIC_3D_LOG_LISSAJOU_KZ, 
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_AX,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_AY,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_AZ, 
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Y,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Y,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_F_Z,
                                                  GVF_PARAMETRIC_3D_LOG_LISSAJOU_PHASE_Z};



/******************************************************************************************************/
/*                                                                                                    */
/*                               Code autogenerated by SymPy                                          */
/*                                                                                                    */
/******************************************************************************************************/
static double sgn(double x)
{
   if (x > 0.)
      return 1.;
   if (x < 0.)
      return -1.;
   return 0. ;
} 

static double linear_increasing_spiral_x(double t, double a_x, UNUSED double a_y, UNUSED double a_z, UNUSED double f_y, UNUSED double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   double linear_increasing_spiral_x_result;
   linear_increasing_spiral_x_result = a_x*t;
   return linear_increasing_spiral_x_result;

}

 
 

static double linear_increasing_spiral_y(double t, UNUSED double a_x, double a_y, UNUSED double a_z, double f_y, double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   double linear_increasing_spiral_y_result;
   linear_increasing_spiral_y_result = a_y*t*cos(2*M_PI*f_y*log(fabs(t) + 1) + phi_y);
   return linear_increasing_spiral_y_result;

}

 
 

static double linear_increasing_spiral_z(double t, UNUSED double a_x, UNUSED double a_y, double a_z, UNUSED double f_y, UNUSED double phi_y, double f_z, double phi_z) {

   double linear_increasing_spiral_z_result;
   linear_increasing_spiral_z_result = a_z*t*sin(2*M_PI*f_z*log(fabs(t) + 1) + phi_z);
   return linear_increasing_spiral_z_result;

}

/****************************************************************/
 
 

static double linear_increasing_spiral_d_x(UNUSED double t, double a_x, UNUSED double a_y, UNUSED double a_z, UNUSED double f_y, UNUSED double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   double linear_increasing_spiral_d_x_result;
   linear_increasing_spiral_d_x_result = a_x;
   return linear_increasing_spiral_d_x_result;

}

 
 

static double linear_increasing_spiral_d_y(double t, UNUSED double a_x, double a_y, UNUSED double a_z, double f_y, double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   double linear_increasing_spiral_d_y_result;
   linear_increasing_spiral_d_y_result = -2*sgn(t)*M_PI*a_y*f_y*t*sin(2*M_PI*f_y*log(fabs(t) + 1) + phi_y)/((fabs(t) + 1)) + a_y*cos(2*M_PI*f_y*log(fabs(t) + 1) + phi_y);
   return linear_increasing_spiral_d_y_result;

}

 
 

static double linear_increasing_spiral_d_z(double t, UNUSED double a_x, UNUSED double a_y, double a_z, UNUSED double f_y, UNUSED double phi_y, double f_z, double phi_z) {

   double linear_increasing_spiral_d_z_result;
   linear_increasing_spiral_d_z_result = sgn(t)*2*M_PI*a_z*f_z*t*cos(2*M_PI*f_z*log(fabs(t) + 1) + phi_z)/((fabs(t) + 1)) + a_z*sin(2*M_PI*f_z*log(fabs(t) + 1) + phi_z);
   return linear_increasing_spiral_d_z_result;

}

/****************************************************************/
 
 
static double linear_increasing_spiral_dd_x(UNUSED double t, UNUSED double a_x, UNUSED double a_y, UNUSED double a_z, UNUSED double f_y, UNUSED double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   int linear_increasing_spiral_dd_x_result;
   linear_increasing_spiral_dd_x_result = 0;
   return linear_increasing_spiral_dd_x_result;

}

 
 

static double linear_increasing_spiral_dd_y(double t, UNUSED double a_x, double a_y, UNUSED double a_z, double f_y, double phi_y, UNUSED double f_z, UNUSED double phi_z) {

   double linear_increasing_spiral_dd_y_result;
   linear_increasing_spiral_dd_y_result = -4*pow(M_PI, 2)*a_y*pow(f_y, 2)*t*cos(2*M_PI*f_y*log(fabs(t) + 1) + phi_y)/pow(fabs(t) + 1, 2) - 4*M_PI*a_y*f_y*sgn(t)*sin(2*M_PI*f_y*log(fabs(t) + 1) + phi_y)/((fabs(t) + 1)) + 2*M_PI*a_y*f_y*t*sin(2*M_PI*f_y*log(fabs(t) + 1) + phi_y)/pow(fabs(t) + 1, 2);
   return linear_increasing_spiral_dd_y_result;

}

 
 

static double linear_increasing_spiral_dd_z(double t, UNUSED double a_x, UNUSED double a_y, double a_z, UNUSED double f_y, UNUSED double phi_y, double f_z, double phi_z) {

   double linear_increasing_spiral_dd_z_result;
   linear_increasing_spiral_dd_z_result = -4*pow(M_PI, 2)*a_z*pow(f_z, 2)*t*sin(2*M_PI*f_z*log(fabs(t) + 1) + phi_z)/pow(fabs(t) + 1, 2) + 4*M_PI*a_z*f_z*sgn(t)*cos(2*M_PI*f_z*log(fabs(t) + 1) + phi_z)/((fabs(t) + 1)) - 2*M_PI*a_z*f_z*t*cos(2*M_PI*f_z*log(fabs(t) + 1) + phi_z)/pow(fabs(t) + 1, 2);
   return linear_increasing_spiral_dd_z_result;

}

/******************************************************************************************************/
/*                                                                                                    */
/*                               End of auto-generated code                                           */
/*                                                                                                    */
/******************************************************************************************************/

void gvf_parametric_3d_log_lissajou_info(float *f1, float *f2, float *f3, float *f1d, float *f2d, float *f3d,
                                  float *f1dd, float *f2dd, float *f3dd)
{
  float ax = gvf_parametric_trajectory.p_parametric[0];
  float ay = gvf_parametric_trajectory.p_parametric[1];
  float az = gvf_parametric_trajectory.p_parametric[2];
  float f_y = gvf_parametric_trajectory.p_parametric[3];
  float phi_y = gvf_parametric_trajectory.p_parametric[4];
  float f_z = gvf_parametric_trajectory.p_parametric[5];
  float phi_z = gvf_parametric_trajectory.p_parametric[6];

  float w = gvf_parametric_control.w;
  float wb = w * gvf_parametric_control.beta * gvf_parametric_control.s;


  *f1 = linear_increasing_spiral_x(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f2 = linear_increasing_spiral_y(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f3 = linear_increasing_spiral_z(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f1d = linear_increasing_spiral_d_x(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f2d = linear_increasing_spiral_d_y(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f3d = linear_increasing_spiral_d_z(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f1dd = linear_increasing_spiral_dd_x(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f2dd = linear_increasing_spiral_dd_y(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
  *f3dd = linear_increasing_spiral_dd_z(wb,ax,ay,az,f_y,phi_y,f_z,phi_z);
}