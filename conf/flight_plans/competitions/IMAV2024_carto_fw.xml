<?xml version="1.0"?>
<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">
<flight_plan alt="40" ground_alt="5" home_mode_height="30" lat0="51.4046689" lon0="-2.8193400" max_dist_from_home="600" name="IMAV2024 Carto fixed-wing" qfu="250." security_height="10">
  <header>
#include "modules/datalink/datalink.h"
static inline bool delay_test_rc(bool test, int delay) {
  static int nb = 0;
  if (test) {
    nb++;
    if (nb == delay) {
      nb = 0;
      return true;
    }
    return false;
  } else {
    nb = 0;
    return false;
  }
}
static inline bool delay_test_gf(bool test, int delay) {
  static int nb = 0;
  if (test) {
    nb++;
    if (nb == delay) {
      nb = 0;
      return true;
    }
    return false;
  } else {
    nb = 0;
    return false;
  }
}

#if DIGITAL_CAM
#define LINE_START_FUNCTION if (mapping_shot) { dc_Survey(mapping_shot_distance); } else { dc_autoshoot = DC_AUTOSHOOT_STOP; }
#define LINE_STOP_FUNCTION dc_autoshoot = DC_AUTOSHOOT_STOP;
#endif

#define NavQdrCloseToAxis(_from, _to) NavQdrCloseTo(DegOfRad(-atan2f(WaypointY(_to) - WaypointY(_from), WaypointX(_to) - WaypointX(_from))))
  </header>
  <waypoints>
    <waypoint name="HOME" x="0" y="0"/>
    <waypoint name="STDBY" x="33.027" y="-40.427"/>
    <waypoint alt="5" name="TD" x="-2.818" y="9.54"/>
    <waypoint alt="25" name="AF" x="112.927" y="69.016"/>
    <waypoint name="_BASELEG" x="168.8" y="-13.8"/>
    <waypoint name="CLIMB" x="-121.049" y="-95.346"/>
    <waypoint name="P1" x="164.51" y="27.772"/>
    <waypoint name="P2" x="-85.857" y="-127.667"/>
    <waypoint name="_C1" x="164.51" y="27.772"/>
    <waypoint name="_C2" x="-85.857" y="-127.667"/>
    <waypoint name="MAP1" x="196.241" y="75.436"/>
    <waypoint name="MAP2" x="316.762" y="-62.664"/>
    <waypoint name="MAP3" x="-45.783" y="-272.004"/>
    <waypoint name="MAP4" x="-129.4" y="-123.311"/>
    <waypoint name="ZBC" x="84.959" y="-93.962"/>
    <waypoint name="ZBDIR" x="133.029" y="-67.177"/>
    <waypoint name="_KILL1" x="189.216" y="163.751"/>
    <waypoint name="_KILL2" x="540.415" y="-63.411"/>
    <waypoint name="_KILL3" x="-72.668" y="-399.168"/>
    <waypoint name="_KILL4" x="-259.616" y="-87.104"/>
    <waypoint name="_FLY1" x="180.673" y="129.783"/>
    <waypoint name="_FLY2" x="454.314" y="-70.491"/>
    <waypoint name="_FLY3" x="-52.468" y="-352.381"/>
    <waypoint name="_FLY4" x="-205.315" y="-106.372"/>
  </waypoints>
  <sectors>
    <sector color="red" name="Kill">
      <corner name="_KILL1"/>
      <corner name="_KILL2"/>
      <corner name="_KILL3"/>
      <corner name="_KILL4"/>
    </sector>
    <sector color="green" name="Flight_Area">
      <corner name="_FLY1"/>
      <corner name="_FLY2"/>
      <corner name="_FLY3"/>
      <corner name="_FLY4"/>
    </sector>
    <sector color="yellow" name="Survey">
      <corner name="MAP1"/>
      <corner name="MAP2"/>
      <corner name="MAP3"/>
      <corner name="MAP4"/>
    </sector>
  </sectors>
  <variables>
    <variable init="40." var="mapping_height" min="20." max="120." step="1."/>
    <variable init="25." var="mapping_sweep" min="5." max="20." step="0.1"/>
    <variable init="300." var="mapping_length" min="50." max="600." step="10."/>
    <variable init="5." var="mapping_lines" min="3." max="15." step="0.1"/>
    <variable init="0" var="mapping_shot" min="0" max="1" step="1"/>
    <variable init="20." var="mapping_shot_distance" min="5." max="60." step="0.1"/>
  </variables>
  <modules>
    <module name="nav" type="survey_zamboni"/>
    <module name="nav" type="poles"/>
  </modules>
  <!--exceptions>
    <exception cond="(delay_test_rc(RCLost(),20) @AND
      !(IndexOfBlock('Takeoff') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('Land Right AF-TD')) @AND
      (autopilot.launch == true) )" deroute="EmergencyLanding"/>
    <exception cond="(datalink_time @GT 10 @AND
      !(IndexOfBlock('Takeoff') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('Land Right AF-TD')) @AND
      (autopilot.launch == true) )" deroute="EmergencyLanding"/>
    <exception cond="(delay_test_gf(!InsideFlyZone(GetPosX(), GetPosY()),10) @AND
      !(IndexOfBlock('Takeoff') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('Land Right AF-TD')) @AND
      (autopilot.launch == true) )" deroute="EmergencyLanding"/>
  </exceptions-->
  <blocks>
    <block name="Wait GPS">
      <set value="1" var="autopilot.kill_throttle"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 10)"/>
    </block>
    <block name="Holding point">
      <set value="1" var="autopilot.kill_throttle"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    <block group="home" key="t" name="Takeoff" strip_button="Takeoff (wp CLIMB)" strip_icon="takeoff.png">
      <exception cond="GetPosAlt() @GT GetAltRef()+20" deroute="Endurance"/>
      <set value="0" var="autopilot.kill_throttle"/>
      <set value="0" var="autopilot.flight_time"/>
      <go from="HOME" pitch="30" throttle="0.8" vmode="throttle" wp="CLIMB"/>
      <deroute block="Align Zamboni"/>
    </block>
    <block group="home" key="Ctrl+a" name="Standby" strip_button="Standby" strip_icon="home.png">
      <circle radius="nav_radius" wp="STDBY"/>
    </block>
    <block name="Endurance" strip_button="Endurance" group="mission">
      <set var="mapping_shot" value="0"/>
      <call_once fun="nav_poles_init(WP_P1, WP_P2, WP__C1, WP__C2, nav_radius)"/>
      <oval p1="_C1" p2="_C2" radius="nav_radius" until="nav_oval_count==3"/>
      <deroute block="Align Zamboni"/>
    </block>
    <block name="Align Zamboni">
      <circle radius="nav_radius" until="NavQdrCloseToAxis(WP_STDBY,WP_ZBC) @AND fabsf(GetPosAlt() - WaypointAlt(WP_ZBC)) @LT 10." wp="STDBY"/>
    </block>
    <block group="mission" name="ZamboniSurvey" strip_button="Zamboni">
      <set var="mapping_shot" value="1"/>
      <call_once fun="pprzlink_cam_ctrl_set_expo(PPRZLINK_CAM_AUTO_EXPO)"/>
      <call_once fun="nav_survey_zamboni_setup(WP_ZBC, WP_ZBDIR, mapping_length, mapping_sweep, mapping_lines, GetAltRef()+mapping_height)"/>
      <call fun="nav_survey_zamboni_run()"/>
      <!--deroute block="Standby"/-->
      <deroute block="Land Left AF-TD"/>
    </block>
    <block group="land" name="Land Right AF-TD" strip_button="Land right (wp AF-TD)" strip_icon="land-right.png">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block group="land" name="Land Left AF-TD" strip_button="Land left (wp AF-TD)" strip_icon="land-left.png">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block name="land">
      <call_once fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() @GT 0.5" wp="_BASELEG"/>
      <circle radius="nav_radius" until="And(NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10), 10 @GT fabs(GetPosAlt() - WaypointAlt(WP__BASELEG)))" wp="_BASELEG"/>
    </block>
    <block name="final">
      <exception cond="GetAltRef() + 3 @GT GetPosAlt()" deroute="flare"/>
      <go from="AF" hmode="route" vmode="glide" wp="TD"/>
    </block>
    <block name="flare">
      <go exceeding_time="10" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="EmergencyLanding">
      <go throttle="0." vmode="throttle" wp="HOME"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    <block name="SetExpo">
      <call_once fun="pprzlink_cam_ctrl_set_expo(PPRZLINK_CAM_AUTO_EXPO)"/>
      <return/>
    </block>
  </blocks>
</flight_plan>
