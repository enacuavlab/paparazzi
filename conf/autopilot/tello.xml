<!DOCTYPE autopilot SYSTEM "autopilot.dtd">

<autopilot name="Tello Autopilot (remote piloting with speed)">

  <state_machine name="ap" freq="PERIODIC_FREQUENCY" gcs_mode="true" settings_mode="true" settings_handler="autopilot_generated|SetModeHandler">

    <includes>
      <include name="generated/airframe.h"/>
      <include name="autopilot.h"/>
      <include name="autopilot_rc_helpers.h"/>
      <include name="navigation.h"/>
      <include name="guidance.h"/>
      <include name="subsystems/radio_control.h"/>
      <include name="subsystems/gps.h"/>
      <define name="MODE_MANUAL" value="AP_MODE_SPEED" cond="ifndef MODE_MANUAL"/>
      <define name="MODE_AUTO1" value="AP_MODE_GUIDED" cond="ifndef MODE_AUTO1"/>
      <define name="MODE_AUTO2" value="AP_MODE_NAV" cond="ifndef MODE_AUTO2"/>
      <define name="RCLost()" value="(radio_control.status == RC_REALLY_LOST)"/>
    </includes>

    <settings>
      <dl_setting var="autopilot.kill_throttle" min="0" step="1" max="1" module="autopilot" values="Resurrect|Kill" handler="KillThrottle"/>
    </settings>

    <control_block name="speed_loop">
    </control_block>

    <exceptions>
      <exception cond="too_far_from_home" deroute="HOME"/>
      <exception cond="kill_switch_is_on()" deroute="KILL"/>
    </exceptions>

    <mode name="SPEED">
      <select cond="RCMode0()"/>
      <control freq="NAV_FREQ">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call_block name="speed_loop"/>
      </control>
      <exception cond="RCLost()" deroute="KILL"/>
    </mode>

    <mode name="GUIDED">
      <select cond="RCMode1()" exception="HOME"/>
      <on_enter>
        <call fun="guidance_h_hover_enter()"/>
        <call fun="guidance_v_mode = GUIDANCE_V_MODE_GUIDED"/>
        <call fun="guidance_v_guided_enter()"/>
      </on_enter>
      <control freq="NAV_FREQ">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call fun="guidance_v_read_rc()"/>
        <!--call fun="guidance_v_thrust_adapt(autopilot_in_flight())"/-->
        <call fun="guidance_v_guided_run(autopilot_in_flight())"/>
        <call fun="guidance_h_guided_run(autopilot_in_flight())"/>
        <call_block name="speed_loop"/>
      </control>
      <exception cond="GpsIsLost() && autopilot_in_flight()" deroute="KILL"/>
    </mode>

    <mode name="NAV">
      <select cond="$DEFAULT_MODE"/>
      <select cond="RCMode2()" exception="HOME"/>
      <on_enter>
        <call fun="guidance_h_nav_enter()"/>
        <call fun="guidance_v_z_enter()"/>
      </on_enter>
      <control freq="NAV_FREQ">
        <call fun="nav_periodic_task()"/>
      </control>
      <control>
        <call fun="guidance_v_read_rc()"/>
        <!--call fun="guidance_v_thrust_adapt(autopilot_in_flight())"/-->
        <call fun="guidance_v_from_nav(autopilot_in_flight())"/>
        <call fun="guidance_h_from_nav(autopilot_in_flight())"/>
        <call_block name="speed_loop"/>
      </control>
      <exception cond="GpsIsLost() && autopilot_in_flight()" deroute="KILL"/>
    </mode>

    <mode name="HOME">
      <on_enter>
        <call fun="guidance_h_nav_enter()"/>
        <call fun="guidance_v_z_enter()"/>
      </on_enter>
      <control freq="NAV_FREQ">
        <call fun="nav_home()"/>
      </control>
      <control>
        <call fun="guidance_v_read_rc()"/>
        <!--call fun="guidance_v_thrust_adapt(autopilot_in_flight())"/-->
        <call fun="guidance_v_from_nav(autopilot_in_flight())"/>
        <call fun="guidance_h_from_nav(autopilot_in_flight())"/>
        <call_block name="speed_loop"/>
      </control>
      <exception cond="GpsIsLost()" deroute="KILL"/>
    </mode>

    <!-- Safe landing -->
    <mode name="KILL">
      <on_enter>
        <!--call fun="tello_land()"/-->
      </on_enter>
      <control>
        <!--call fun="stabilization_attitude_set_failsafe_setpoint()"/>
        <call fun="stabilization_attitude_run(autopilot_in_flight())"/>
        <call fun="gv_update_ref_from_zd_sp(guidance_v_zd_sp, stateGetPositionNed_i()->z)"/>
        <call fun="run_hover_loop(autopilot_in_flight())"/>
        <call_block name="set_actuators"/-->
      </control>
      <exception cond="!GpsIsLost()" deroute="$LAST_MODE"/>
    </mode>

  </state_machine>

</autopilot>
